
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>My SeedIn Portfolio</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
    <link href="css/style.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>    
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <strong><a class="navbar-brand" href="#">My SeedIn Portfolio</a></strong>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="investments.html">Investments</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="mydata.html">My Data</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="about.html">About</a>
            </li>
        </ul>
    </div>
</nav>

<main role="main" class="container-fluid">
<style>
    .progress {
        margin-bottom: 3px;
        height: 5px;
    }
</style>
<div class="row">
    <div class="col-md-12">
        <h2>Dashboard</h2>
        <div id="notifications"></div>
    </div>
</div>
<div class="row">
    <div class="col-md-2">
        <small class="form-text text-muted">From Date</small>
        <input type="date" id="fromDate" class="form-control" placeholder="yyyy-mm-dd" onchange="filterAndCalculateInvestments()">
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">To Date</small>
        <input type="date" id="toDate" class="form-control" placeholder="yyyy-mm-dd" onchange="filterAndCalculateInvestments()">    
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">Repayment Method</small>
        <select id="repaymentMethod" class="custom-select" onchange="filterAndCalculateInvestments()">
            <option>All</option>
            <option>Balloon</option>
            <option>Equal</option>
        </select>
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">Issuer</small>
        <select id="issuer" class="custom-select" onchange="filterAndCalculateInvestments()">
            <option>All</option>
        </select>
    </div>
</div>
<p></p>
<div class="row">
    <div class="col-md-6">    
        <div class="form-group">            
            <label>Amount Invested / Projected Net</label>
            <div class="progress">
                <div id="gainProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="input-group">
                <input id="amountInvested" class="form-control form-control-lg" type="text" readonly>
                <div class="input-group-append">
                    <span id="investmentGainIncrease" class="input-group-text">0.00% Gain</span>
                </div>
            </div>
        </div>                    
        <div class="form-group">
            <label>Net Payout</label>
            <div class="progress">
                <div id="netPayoutProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <input id="netPayout" class="form-control form-control-lg" type="text" readonly>
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">                
            <label>Net Earnings</label>
            <div class="progress">
                <div id="netEarningsProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <input id="netEarnings" class="form-control form-control-lg" type="text" readonly>
        </div>
        <div class="form-group">
            <label>Completed Projects</label>
            <div class="progress">
                <div id="completedProjectsProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <input id="completedProjects" class="form-control form-control-lg" type="text" readonly>
        </div>
    </div>
</div>
<div class="modal fade" id="negativeGainModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" rol="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Negative Gains</h5>
            </div>
            <div class="modal-body">
                You have a negative gain on the <strong>selected range of date</strong> 
                because you have <strong>more balloon repayment projects than equal repayment projects</strong>. 
                Unlike equal repayment projects, your invested funds in a balloon repayment project is 
                <strong>not divided into months but summed as a whole</strong>. Some of the interests might have 
                been paid which already lowered your negative gain. As we move closer to the maturity dates more interest earned will be released and 
                the negative gain will soon decrease and become positive <strong>once the tenure of the balloon projects have been reached</strong>. 
                So within the range of dates you have selected, some of your <strong>balloon projects 
                have not yet reached their tenure</strong> which resulted to a negative gain.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-seconary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="scripts/mydate.js"></script>
<script src="scripts/investment.js"></script>
<script src="scripts/database.js"></script>
<script src="scripts/numberutils.js"></script>
<script>
    var database = new Database();
    var investments = []

    // Calculate the dashboard
    $(document).ready(function() {
        // Load the earliest and latest dates
        investments = database.getInvestments();
        resetFields();

        var dates = Investment.getEarliestAndLatestInvestmentDates(investments);

        if(dates == null)
            return;

        $("#fromDate").val(dates["earliest"].toString());
        $("#toDate").val(dates["latest"].toString());

        // Load the issuers
        var issuers = Investment.getIssuers(investments);

        for(var i = 0; i < issuers.length; i++) {
            var issuer = issuers[i];
            $("#issuer").append("<option>" + issuer + "</option>");
        }

        filterAndCalculateInvestments();
    });    

    // Reset the fields
    function resetFields() {
        $("#amountInvested").val(NumberUtils.formatCurrency(0) + " / " + NumberUtils.formatCurrency(0));
        $("#investmentGainIncrease").html("0% Gain");
        $("#netEarnings").val(NumberUtils.formatCurrency(0) + " out of " + NumberUtils.formatCurrency(0));
        $("#netPayout").val(NumberUtils.formatCurrency(0) + " out of " + NumberUtils.formatCurrency(0));
        $("#completedProjects").val(0 + " out of " + 0);
    }

    // Filter all investments that fits on the given dates and calculate the dashboard elements
    function filterAndCalculateInvestments() {
        var earliestDate = MyDate.toMyDate($("#fromDate").val());
        var latestDate = MyDate.toMyDate($("#toDate").val());
        var repaymentMethod = $("#repaymentMethod").val();
        var issuer = $("#issuer").val();

        if(earliestDate == null || latestDate == null) {
            resetFields();
            return;
        }

        // Get only investments at the given date range
        var filteredInvestments = Investment.filterInvestmentsByDate(investments, earliestDate, latestDate);
        filteredInvestments = Investment.filterInvestmentsByRepaymentMethod(filteredInvestments, repaymentMethod);
        filteredInvestments = Investment.filterInvestmentsByIssuer(filteredInvestments, issuer);

        var currentDate = MyDate.now();
        var amountInvested = 0;
        var completedNetEarnings = 0;
        var netEarnings = 0;
        var projectedNetAmount = 0;
        var completedNetPayoutAmount = 0;
        var completedProjects = 0;

        var numPayoutsToday = 0;
        var totalNetEarningsToday = 0;
        var totalPayoutAmountToday = 0;        
        var numMaturedToday = 0;

        for(var i = 0; i < filteredInvestments.length; i++) {
            var investment = filteredInvestments[i];

            // Break down each investment schedule and include only those schedule that is exactly in the
            // date range, filters out months that
            var schedules = investment.generateRepaymentSchedule();
            
            if(schedules[schedules.length - 1]["date"].compareTo(currentDate) == 0)
                numMaturedToday;

            if(schedules[schedules.length - 1]["date"].compareTo(currentDate) <= 0)
                completedProjects++;
			
			// If repayment method is balloon, there's no monthly investment.
			// So we put the whole investment amount.
			if(investment.properties["repaymentMethod"] == "Balloon")
				amountInvested += investment.properties["investmentAmount"];

			
            for(var j = 0; j < schedules.length; j++) {
                var schedule = schedules[j];

                if(schedule["date"].compareTo(earliestDate) >= 0 && schedule["date"].compareTo(latestDate) <= 0) {
                    projectedNetAmount += schedule["netPayout"];
					
					// For equal repayment method, we consider the investment as divided as equal as well.
					if(investment.properties["repaymentMethod"] == "Equal")
						amountInvested += schedule["netPayout"] - schedule["netInterestPayout"];

                    netEarnings += schedule["netInterestPayout"];

                    if(schedule["date"].compareTo(currentDate) <= 0) {
                        if(schedule["date"].compareTo(currentDate) == 0) {
                            numPayoutsToday++;
                            totalNetEarningsToday += schedule["netInterestPayout"];
                            totalPayoutAmountToday += schedule["netPayout"]; 
                        }

                        completedNetEarnings += schedule["netInterestPayout"];
                        completedNetPayoutAmount += schedule["netPayout"];
                    }
                }
            }
        }

        var gainPercent = (((projectedNetAmount - amountInvested) / amountInvested) * 100).toFixed(2);

        if(isNaN(gainPercent))
            gainPercent = 0;

        $("#amountInvested").val(NumberUtils.formatCurrency(amountInvested) + " / " + NumberUtils.formatCurrency(projectedNetAmount));        
        $("#investmentGainIncrease").html(gainPercent + "% Gain");

        $("#netEarnings").val(NumberUtils.formatCurrency(completedNetEarnings) + " out of " + NumberUtils.formatCurrency(netEarnings));
        $("#netPayout").val(NumberUtils.formatCurrency(completedNetPayoutAmount) + " out of " + NumberUtils.formatCurrency(projectedNetAmount));
        $("#completedProjects").val(completedProjects + " out of " + filteredInvestments.length);

        // Progress bars
        var netEarningsPercent = completedNetEarnings / netEarnings * 100;
        var netPayoutPercent = completedNetPayoutAmount / projectedNetAmount * 100;
        var completedProjectsPercent = completedProjects / filteredInvestments.length * 100;

        if(isNaN(netEarningsPercent))
            netEarningsPercent = 0;

        if(isNaN(netPayoutPercent))
            netPayoutPercent = 0;

        if(isNaN(completedProjectsPercent))
            completedProjectsPercent = 0;

        $("#gainProgress").css("width", gainPercent + "%");
        $("#netEarningsProgress").css("width", netEarningsPercent + "%");
        $("#netPayoutProgress").css("width", netPayoutPercent + "%");
        $("#completedProjectsProgress").css("width", completedProjectsPercent + "%");

        // Notice of payouts
        $("#notifications").empty();

        if(numPayoutsToday > 0) {
            var message = "<strong>Heads up!</strong> You have <strong>2 payout(s)</strong> today with a <strong>Total Net Earnings</strong> amount of ";
            message += "<strong>" + NumberUtils.formatCurrency(totalNetEarningsToday) + "</strong> and <strong>Total Net Payout</strong> amount of ";
            message += "<strong>" + NumberUtils.formatCurrency(totalPayoutAmountToday) + "</strong>. These amounts were already credited to this ";
            message += "dashboard. Check that it matches your SeedIn account balance after SeedIn releases payouts.";

            $("#notifications").append("<div class='alert alert-warning'>" + message + "</div>");
        }

        if(numMaturedToday > 0)
            $("#notifications").append("<div class='alert alert-success'><strong>Congratulations!</strong> You have <strong>" + numMaturedToday + " project(s)</strong> that reached the maturity date today.</div>");

        if(gainPercent < 0)
            $("#notifications").append("<div class='alert alert-info'>You got a <a href='#' data-toggle='modal' data-target='#negativeGainModal'><strong><u>negative gain</u></strong></a>.</div>") 
    }

</script>
</main>
</body>
</html>