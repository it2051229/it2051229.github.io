
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>My SeedIn Portfolio</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
    <link href="css/style.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>    
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <strong><a class="navbar-brand" href="#">My SeedIn Portfolio</a></strong>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="investments.html">Investments</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="mydata.html">My Data</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="about.html">About</a>
            </li>
        </ul>
    </div>
</nav>

<main role="main" class="container-fluid"><style>
    table th,
    table td {
        min-width: 100px;
    }
</style>
<div class="row">
    <div class="col-md-12">
        <h2>Investments</h2>
        <p>
            <a href="investments.add.html" class="btn btn-primary">Add Investment</a>            
        </p>
    </div>
</div>
<div class="row">
    <div class="col-md-2">
        <small class="form-text text-muted">From Date</small>
        <input type="date" id="fromDate" class="form-control" placeholder="yyyy-mm-dd" onkeyup="sortAndFilterInvestments();">                
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">To Date</small>
        <input type="date" id="toDate" class="form-control" placeholder="yyyy-mm-dd" onkeyup="sortAndFilterInvestments();">    
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">Sorted By</small>
        <select id="sortedBy" class="custom-select" onchange="sortAndFilterInvestments();">
            <option>Project ID</option>
            <option>Investment Amount</option>
            <option>Interest Rate</option>
            <option>Next Pay Date</option>
            <option>Maturity Date</option>
        </select>
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">Sort Order</small>
        <select id="sortOrder" class="custom-select" onchange="sortAndFilterInvestments();">
            <option>Descending</option>
            <option>Ascending</option>
        </select>
    </div>
    <div class="col-md-2">
        <small class="form-text text-muted">Repayment Method</small>
        <select id="repaymentMethod" class="custom-select" onchange="sortAndFilterInvestments();">
            <option>All</option>
            <option>Balloon</option>
            <option>Equal</option>
        </select>
    </div>
</div>
<p></p>
<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th class="align-middle">Project ID</th>
                        <th class="align-middle">Amount Invested</th>
                        <th class="align-middle">Gross %</th>
                        <th class="align-middle">Net Payout</th>
                        <th class="align-middle">Next Pay Date</th>
                        <th class="align-middle">Next Pay Amount</th>
                        <th class="align-middle">Maturity Date</th>
                    </tr>
                </thead>
                <tbody id="investments">
                    <tr>
                        <th scope="row"><a href="#">...</a></th>
                        <td>...</td>
                        <td>...</td>
                        <td>...</td>
                        <td>...</td>
                        <td>...</td>
                        <td>...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script src="scripts/mydate.js"></script>
<script src="scripts/investment.js"></script>
<script src="scripts/database.js"></script>
<script src="scripts/numberutils.js"></script>
<script>        
    var database = new Database();
    var investments = [];

    // Start displaying the investments
    $(document).ready(function() {
        investments = database.getInvestments();

        if(investments.length == 0)
            return;

        // Find the earliest and latest date
        var dates = Investment.getEarliestAndLatestInvestmentDates(investments);

        // Set the date filters
        $("#fromDate").val(dates["earliest"].toString());
        $("#toDate").val(dates["latest"].toString());

        // Set the ordering
        if("investments.sortedBy" in localStorage)
            $("#sortedBy").val(localStorage.getItem("investments.sortedBy"));

        if("investments.sortOrder" in localStorage)
            $("#sortOrder").val(localStorage.getItem("investments.sortOrder"));


        sortAndFilterInvestments();
    });

    // Sort and filter the investments based on settings
    function sortAndFilterInvestments() {
        $("#investments").empty();

        var earliestDate = MyDate.toMyDate($("#fromDate").val());
        var latestDate = MyDate.toMyDate($("#toDate").val());
        var repaymentMethod = $("#repaymentMethod").val();

        if(earliestDate == null || latestDate == null)
            return;

        // Get only investments at the given date range
        var filteredInvestments = Investment.filterInvestmentsByDateAndRepaymentMethod(investments, earliestDate, latestDate, repaymentMethod);

        // Sort it
        var sortedBy = $("#sortedBy").find(":selected").val();
        var sortOrder = $("#sortOrder").find(":selected").val();

        // Save sort option
        localStorage.setItem("investments.sortedBy", sortedBy);
        localStorage.setItem("investments.sortOrder", sortOrder);

        // Sort in Ascending by default
        filteredInvestments.sort(function(investmentA, investmentB) {
            if(sortedBy == "Project ID")
                return investmentA.properties["propertyId"] - investmentB.properties["propertyId"];
            
            if(sortedBy == "Investment Amount")
                return investmentA.properties["investmentAmount"] - investmentB.properties["investmentAmount"];
            
            if(sortedBy == "Interest Rate")
                return investmentA.properties["grossInterestRate"] - investmentB.properties["grossInterestRate"];
            
            if(sortedBy == "Next Pay Date") {
                dateA = investmentA.calculateNextPayDate(); 
                dateB = investmentB.calculateNextPayDate();

                if(dateA == null && dateB == null)
                    return 0;
                
                if(dateA == null)
                    return 1;
                
                if(dateB == null)
                    return -1;
                    
                return dateA.compareTo(dateB);
            }

            if(sortedBy == "Maturity Date")
                return investmentA.calculateMaturityDate().compareTo(investmentB.calculateMaturityDate());

            return 0;
        });

        // Reverse if descending
        if(sortOrder == "Descending")
            filteredInvestments.reverse();
        
        for(var i = 0; i < filteredInvestments.length; i++) {
            var investment = filteredInvestments[i];            
            var payDateDetails = investment.calculateNextPayAndMaturityDate();

            $("#investments").append("<tr>"
                + "<th scope='row'><a href='investments.update.html?id=" + investment.properties["projectId"] + "'>" + investment.properties["projectId"] + "</a></th>"
                + "<td>" + NumberUtils.formatCurrency(investment.properties["investmentAmount"]) + "</td>"
                + "<td>" + (investment.properties["grossInterestRate"] * 100).toFixed(2) + "% p.a. " + investment.properties["repaymentMethod"] + "</td>"
                + "<td>" + NumberUtils.formatCurrency(investment.properties["investmentAmount"] + investment.calculateNetGainAmount()) + "</td>"
                + "<td>" + payDateDetails["nextPayDate"].toString() + " </td>"
                + "<td>" + NumberUtils.formatCurrency(payDateDetails["nextPayAmount"]) + "</td>"
                + "<td>" + payDateDetails["maturityDate"].toString() + "</td>"
                + "</tr>");
        }
    }
</script>
    </main>
</body>
</html>